<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    DDOS简介 |  
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-tips-ddos"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  DDOS简介
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/08/tips-ddos/" class="article-date">
  <time datetime="2020-08-11T15:46:56.000Z" itemprop="datePublished">2020-08-11</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/Tips/">Tips</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">2.1k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">7 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li>DoS（Denial of Service）, 即拒绝服务攻击</li>
<li>分布式拒绝服务(DDoS:Distributed Denial of Service)攻击指借助于客户/服务器技术, 将多个计算机联合起来作为攻击平台, 对一个或多个目标发动DDoS攻击, 从而成倍地提高拒绝服务攻击的威力. </li>
<li>CC(ChallengeCollapsar)攻击者借助代理服务器生成指向受害主机的合法请求, 实现DDOS和伪装. DDoS是针对IP的攻击, 而CC攻击的是网页. </li>
<li>CC攻击的变异品种 慢速攻击: 对任何一个开放了HTTP访问的服务器HTTP服务器, 先建立了一个连接, 指定一个比较大的content-length, 然后以非常低的速度发包, 比如1-10s发一个字节, 然后维持住这个连接不断开. 如果客户端持续建立这样的连接, 那么服务器上可用的连接将一点一点被占满, 从而导致拒绝服务. </li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>慢速攻击主要利用的是thread-based架构的服务器的特性, 这种服务器会为每个新连接打开一个线程, 它会等待接收完整个HTTP头部才会释放连接. 比如Apache会有一个超时时间来等待这种不完全连接（默认是300s）, 但是一旦接收到客户端发来的数据, 这个超时时间会被重置. 正是因为这样, 攻击者可以很容易保持住一个连接, 因为攻击者只需要在即将超时之前发送一个字符, 便可以延长超时时间. 而客户端只需要很少的资源, 便可以打开多个连接, 进而占用服务器很多的资源. </p>
<p>经验证, Apache, httpd采用thread-based架构, 很容易遭受慢速攻击. 而另外一种event-based架构的服务器, 比如nginx和lighttpd则不容易遭受慢速攻击. </p>
<h2 id="攻击症状"><a href="#攻击症状" class="headerlink" title="攻击症状"></a>攻击症状</h2><p>一般遭受CC攻击时, Web服务器会出现80端口对外关闭的现象,  因为这个端口已经被大量的垃圾数据堵塞了正常的连接被中止了. 可以通过在命令行下输入命令netstat -an来查看, 　“SYN_RECEIVED”是TCP连接状态标志, 意思是“正在处于连接的初始同步状态 ”, 表明无法建立握手应答处于等待状态. 这就是攻击的特征, 一般情况下这样的记录一般都会有很多条, 表示来自不同的代理IP的攻击. </p>
<h2 id="防范"><a href="#防范" class="headerlink" title="防范"></a>防范</h2><h3 id="对DoS和DDoS的防范主要从下面几个方面考虑"><a href="#对DoS和DDoS的防范主要从下面几个方面考虑" class="headerlink" title="对DoS和DDoS的防范主要从下面几个方面考虑:"></a>对DoS和DDoS的防范主要从下面几个方面考虑:</h3><ol>
<li>尽可能对系统加载最新补丁, 并采取有效的合规性配置, 降低漏洞利用风险；</li>
<li>采取合适的安全域划分, 配置防火墙, 入侵检测和防范系统, 减缓攻击. </li>
<li>采用分布式组网, 负载均衡, 提升系统容量等可靠性措施, 增强总体服务能力. </li>
</ol>
<h3 id="可参考措施如下"><a href="#可参考措施如下" class="headerlink" title="可参考措施如下:"></a>可参考措施如下:</h3><ol>
<li>采用高性能的网络设备引<br>首先要保证网络设备不能成为瓶颈, 因此选择路由器, 交换机, 硬件防火墙等设备的时候要尽量选用知名度高,  口碑好的产品.  再就是假如和网络提供商有特殊关系或协议的话就更好了, 当大量攻击发生的时候请他们在网络接点处做一下流量限制来对抗某些种类的DDOS 攻击是非常有效的. </li>
<li>尽量避免 NAT 的使用<br>无论是路由器还是硬件防护墙设备要尽量避免采用网络地址转换 NAT 的使用,  因为采用此技术会较大降低网络通信能力, 其实原因很简单, 因为 NA T 需要对地址来回转换, 转换过程中需要对网络包的校验和进行计算, 因此浪费了很多 CPU 的时间, 但有些时候必须使用 NA T, 那就没有好办法了. </li>
<li>充足的网络带宽保证<br>网络带宽直接决定了能抗受攻击的能力,  假若仅仅有 10M 带宽的话,  无论采取什么措施都很难对抗当今的 SYNFlood 攻击,  至少要选择 100M 的共享带宽, 最好的当然是挂在1000M 的主干上了. 但需要注意的是, 主机上的网卡是 1000M 的并不意味着它的网络带宽就是千兆的,  若把它接在 100M 的交换机上,  它的实际带宽不会超过 100M,  再就是接在 100M的带宽上也不等于就有了百兆的带宽,  因为网络服务商很可能会在交换机上限制实际带宽为10M, 这点一定要搞清楚. </li>
<li>升级主机服务器硬件<br>在有网络带宽保证的前提下, 请尽量提升硬件配置, 要有效对抗<em>每秒 10 万个 SYN 攻击包, 服务器的配置至少应该为: P4 2.4G/DDR512M/SCSI-HD</em>, 起关键作用的主要是 CPU 和内存,  若有志强双 CPU 的话就用它吧,  内存一定要选择 DDR 的高速内存,  硬盘要尽量选择SCSI 的, 别只贪 IDE 价格不贵量还足的便宜, 否则会付出高昂的性能代价, 再就是网卡一定要选用 3COM 或 Intel 等名牌的, 若是 Realtek 的还是用在自己的 PC 上吧. </li>
<li>把网站做成<strong>静态页面</strong><br>大量事实证明, 把网站尽可能做成静态页面, 不仅能大大提高抗攻击能力, 而且还给黑客入侵带来不少麻烦, 至少到为止关于 HTML 的溢出还没出现, 新浪, 搜狐, 网易等门户网站主要都是静态页面,  若你非需要动态脚本调用,  那就把它弄到另外一台单独主机去, 免的遭受攻击时连累主服务器,  当然,  适当放一些不做数据库调用脚本还是可以的,  此外, 最好在需要调用数据库的脚本中拒绝使用代理的访问,  因为经验表明使用代理访问你网站的80%属于恶意行为. </li>
</ol>
<ul>
<li><p>网站架构<br>用户访问到的服务器仅用于前端, 仅运行着nginx用于反向代理. mariadb, apache与PHP已经迁走, 甚至zabbix proxy server也已经完成迁移. 因此, 用户访问到的页面都是缓存在本地的静态页面, 只会对带宽造成压力, 而后端依然坚挺.<br>后端运行着mariadb, Apache与PHP, 且为双节点热备模式<br>解决了双节点的文件, session与数字证书同步等问题.<br>最后, 所有静态文件都使用CDN进行分发, 减轻前端服务器的压力. </p>
</li>
<li><p>HttpGuard(运维工具)<br>说白了还是工具+验证码</p>
</li>
<li><p>iptables &amp; netstat &amp; iftop</p>
<p>  <code>iptables -I INPUT -p tcp --dport 80 -j DROP</code></p>
<ul>
<li><p>-I: 将规则插入到INPUT链的首行</p>
</li>
<li><p>-p: 匹配TCP协议</p>
</li>
<li><p>–dport: 首访端口为HTTP的80端口</p>
</li>
<li><p>-j: 将数据包丢弃</p>
<p><code>netstat -anp | grep TIME_WAIT | wc -l</code></p>
<p>最后是<code>iftop</code>, 一款实时展示网络连接情况的软件, 使用iftop命令打开展示界面后, 分别按下以下按键:</p>
</li>
<li><p>t: 在同一行内展示上下行情况, 节省空间</p>
</li>
<li><p>T: 展示总流量</p>
</li>
<li><p>p: 展示端口</p>
</li>
</ul>
</li>
<li><p>fail2ban（运维工具）</p>
</li>
<li><p>nginx limit_req</p>
</li>
<li><p>内核</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#修改超时时间为30秒, 某些情况可以进一步降低该值</span><br><span class="line">net.ipv4.tcp_fin_timeout &#x3D; 30</span><br><span class="line"></span><br><span class="line">#将keepalive的发送频率降低为20分钟一次</span><br><span class="line">net.ipv4.tcp_keepalive_time &#x3D; 1200</span><br><span class="line"></span><br><span class="line">#开启SYN Cookies, 当SYN队列溢出时启用Cookies</span><br><span class="line">net.ipv4.tcp_syncookies &#x3D; 1</span><br><span class="line"></span><br><span class="line">#开启TIME-WAIT sockets重用功能</span><br><span class="line">net.ipv4.tcp_tw_reuse &#x3D; 1</span><br><span class="line"></span><br><span class="line">#开启TIME-WAIT sockets快速回收功能</span><br><span class="line">net.ipv4.tcp_tw_recycle &#x3D; 1</span><br><span class="line"></span><br><span class="line">#加大SYN队列</span><br><span class="line">net.ipv4.tcp_max_syn_backlog &#x3D; 8192</span><br><span class="line"></span><br><span class="line">#最大TIME_WAIT保持数, 超过将全部清除</span><br><span class="line">net.ipv4.tcp_max_tw_buckets &#x3D; 5000</span><br></pre></td></tr></table></figure>

<h2 id="现有措施"><a href="#现有措施" class="headerlink" title="现有措施"></a>现有措施</h2><ol>
<li>nginx limit_req<blockquote>
<p>影响用户体验不推荐开启</p>
</blockquote>
</li>
<li>预约验证码</li>
<li>一秒操作不超过4次php</li>
<li>验证码登陆</li>
<li>单一登录</li>
</ol>
<h2 id="预计TODO"><a href="#预计TODO" class="headerlink" title="预计TODO"></a>预计TODO</h2><ol>
<li>前后端分离, 前端引入localstorage</li>
<li>服务分级, 瓶颈非io, 为tcpfpm</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%88%86%E5%B8%83%E5%BC%8F%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB/3802159?fromtitle=DDOS&fromid=444572&fr=aladdin">分布式拒绝服务攻击</a><br><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/cc%E6%94%BB%E5%87%BB/10959545?fr=aladdin">cc攻击</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/wpjamer/p/9030259.html">CC攻击原理及防范方法</a><br><a target="_blank" rel="noopener" href="https://ngx.hk/2018/04/17/%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%A2%ABddos%E4%B8%8Ecc%E6%94%BB%E5%87%BB%E7%9A%84%E9%98%B2%E5%BE%A1%E7%BB%8F%E8%BF%87.html">记一次被DDOS与CC攻击的防御经过</a><br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html">Module ngx_http_limit_req_module</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://winterfell-ys.github.io/2020/08/tips-ddos/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Backend/" rel="tag">Backend</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DDoS/" rel="tag">DDoS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tips/" rel="tag">Tips</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web%E5%AE%89%E5%85%A8/" rel="tag">web安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2020/08/learn-http/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            图解HTTP
          
        </div>
      </a>
    
    
      <a href="/2020/07/tips-rabbitmqadmin-reset/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">rabbitmq不访问web端清除队列</div>
      </a>
    
  </nav>

   
 
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2016-2020
        <i class="ri-heart-fill heart_icon"></i> yusheng WINTERFELL
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></s>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/Tokugawa_Aoi_grey.png" alt="厭離穢土 欣求淨土"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


    
    <div id="music">
    
    
    
    <iframe frameborder="no" border="1" marginwidth="0" marginheight="0" width="200" height="86"
        src="//music.163.com/outchain/player?type=2&id=22088505&auto=1&height=66"></iframe>
</div>

<style>
    #music {
        position: fixed;
        right: 15px;
        bottom: 0;
        z-index: 998;
    }
</style>
    
  </div>
</body>

</html>